# Lab 3: [Exploiting NoSQL injection to extract data](https://portswigger.net/web-security/nosql-injection/lab-nosql-injection-extract-data)

![image](https://github.com/user-attachments/assets/930bfc39-809c-4e28-92c2-7e817df7030c)

In this lab scenario,the login functionality is backed by a MongoDB NoSQL database and is vulnerable to injection using MongoDB query operators.

Objective: Exploit the NoSQL injection vulnerability to log in as the `administrator` user.

You can also log in to your own account using the following credentials:
* Username: `wiener`
* Password: `peter`

### Accessing the Lab

#### **Step 1: Navigate to the Account Section**

Click on the **“My Account”** button from the homepage.

![image](https://github.com/user-attachments/assets/c900311a-a08a-4585-860e-8bce794cf224)

#### **Step 2: Log In with Provided Credentials**

Use the default user credentials to log into the application:

* **Username:** `wiener`
* **Password:** `peter`

![image](https://github.com/user-attachments/assets/e4ec3cc2-b72d-428a-98aa-bbd8231f3faa)

#### **Step 3: Capture the Request with Burp Suite**

1. Open **Burp Suite**, go to the **Proxy** tab.
2. Click on the **HTTP History** sub-tab.
3. After logging in, locate the following request:

   ```
   GET /user/lookup?user=wiener
   ```

![image](https://github.com/user-attachments/assets/61846a77-781b-45be-aefb-45f9074731d0)

#### **Step 4: Analyze the Request**

1. Right-click on the request and choose **“Send to Repeater”**.
2. Go to the **Repeater** tab to analyze and modify the request parameters safely.

![image](https://github.com/user-attachments/assets/de07022e-05cf-441a-9cec-ca4fadf2e294)

![image](https://github.com/user-attachments/assets/6f069f9e-76a8-4708-b573-1264a0c1c238)

**Step 5:**

* In Repeater, submit a `'` character in the user parameter. Notice that this causes an error. This may indicate that the user input was not filtered or sanitized correctly.

![image](https://github.com/user-attachments/assets/76090835-468b-4f3a-92c0-a75b405cb00d)

* As if i replace the username `wiener` to `administrator` it give me teh data of user admin so its an leak of informaltion but we cant still login to `adminitrator` account so let generate some more error so we know little more about vulnerabilty

![image](https://github.com/user-attachments/assets/a1c807e5-b0e9-45da-8d96-a56d0e9d4ee6)

* Submit a valid JavaScript payload in the user parameter. For example, you could use `wiener'+'`,

* Make sure to URL-encode the payload by highlighting it and using the hotkey `Ctrl-U`. Notice that it retrieves the account details for the wiener user, which indicates that a form of server-side injection may be occurring.

![image](https://github.com/user-attachments/assets/d590e8d0-5d68-475f-b470-695150c9b392)


**Step 6:** Identify whether you can inject boolean conditions to change the response:

* Now we need to target the hidden filed password in this case we codnt see the hidden passsword filed it is called Projection in mongodb  
* Identify whether you can inject boolean conditions to change the response:
* Let Submit a false condition in the user parameter. For example: `administrator' && '1'=='2`. Make sure to URL-encode the payload. Notice that it retrieves the message Could not find user.

![image](https://github.com/user-attachments/assets/69a62191-75d6-474e-b63d-972f9f7bdbaa)

* Let Submit a true condition in the user parameter. For example: `administrator' && '1'=='1`. Make sure to URL-encode the payload. Notice that it no longer causes an error. Instead, it retrieves the account details for the wiener user. This demonstrates that you can trigger different responses for true and false conditions.

![image](https://github.com/user-attachments/assets/9dcbc775-fca8-4fb5-b83f-344694f37840)

 **Step 5: ** Identify the password length:

* Change the user parameter to `administrator' && this.password.length < 30 || 'a'=='b`, then send the request. Make sure to URL-encode the payload. Notice that the response retrieves the account details for the `administrator` user. This indicates that the condition is true because the password is less than 30 characters.

![image](https://github.com/user-attachments/assets/0484bcb2-1b4d-4cb8-95f5-3ea5d2e79278)

* Reduce the password length in the payload, then resend the request.

![image](https://github.com/user-attachments/assets/c700abcb-2f3f-45ab-8238-9558613edac1)

* Continue to try different lengths.

![image](https://github.com/user-attachments/assets/5a077afe-2420-4cd1-821e-704f7fa77888)

* Notice that when you submit the value `9`, you retrieve the account details for the administrator user,

![image](https://github.com/user-attachments/assets/3b350d2c-c7c1-47b3-b802-ec57ccbb0b47)

* but when you submit the value 8, you receive an error message because the condition is false. This indicates that the password is 8 characters long.

![image](https://github.com/user-attachments/assets/b5b0f6a7-f2c0-4a3a-907e-b47993d6fdf7)

 **Step 6: ** Identify the password character:

As we know the password is 8 chactter long. So basically we need to find each character of password 1 by 1 using this query `administrator' && this.password[§0§]=='§a§`

 In this query the `this.password[0]` is the postion of password `0` show its `0` postion and the `a` represent the 1st charcater of password we can do this manyually like this.

 * Using this query `administrator' && this.password[0]=='a` and Encode this using `ctrl`-`u`. replace the postion of `0` to `1` and check each charater at postion of `a`.
 * Its look likt this `administrator'+%26%26+this.password[1]%3d%3d'a` that depict the postion 1 of password we r trying to use letter `a`.

* The a is not the 1st letter let continua use other alphabet a-z to find the first charater a

![image](https://github.com/user-attachments/assets/eb9bdc0f-4c15-471c-bf5b-ea7de852a750)

* So b is also not 

![image](https://github.com/user-attachments/assets/2e3f7610-879f-42e0-a7dd-e556330c1b40)

* After continua attempt i got to know the 1st keyword of password is `n` bez it show this message when i use n.

![image](https://github.com/user-attachments/assets/e9e2e7af-304f-4754-aae0-718fd2f60af5)

* So Rather than manully finding each charater 1 by 1 we can Use Intruder 

**Step 7:** Enumerating the password:

* Right-click the request and select Send to Intruder.

![image](https://github.com/user-attachments/assets/e437586e-d34e-4a5c-987b-0164df0cc016)

* Select `Cluster bomb attack`   from the attack type drop-down menu.
* Change the user parameter to
```
administrator' && this.password[0]=='a
```
![image](https://github.com/user-attachments/assets/bb7c5e91-33b0-4489-9a16-2521a8c13560)

* Then Encode the payload.

![image](https://github.com/user-attachments/assets/e9d225b2-bfee-4cd6-9a51-dae3e6d20894)

* Mark `0` as 1st payload postion and `a` as 2nd postion of payload the request should look like this `administrator' && this.password[§0§]=='§a§` 

![image](https://github.com/user-attachments/assets/00d25c49-64a2-4bbd-bcca-bb0afb407995)

* In the Payloads side panel, select position `1` from the Payload position drop-down list. Add numbers from `0` to `7` for each character of the password.

![image](https://github.com/user-attachments/assets/d8729727-b9f1-4379-998f-2d8d7d3a71b8)

* Select position `2` from the Payload position drop-down list, then add lowercase letters from `a` to `z`. If you're using Burp Suite Professional, you can use the built-in `a-z list`.

![image](https://github.com/user-attachments/assets/3536217a-5f84-408d-b443-5d19ac4ced29)

* Click  Start attack.

![image](https://github.com/user-attachments/assets/b4fdc2f1-bd6e-4097-908e-78e847523452)

Sorting the length got all the password charater postion.
```
0 -> h
1 -> n
2 -> a
3 -> d
4 -> l
5 -> s
6 -> a
7 -> t
```

**Step 8:** Login in administrator account 
The password we found `hnadlsat`

So let logout this account 

![image](https://github.com/user-attachments/assets/7c8cda02-603f-4878-90fd-ad6cc32b7e11)

And login with administrator
![image](https://github.com/user-attachments/assets/a264935f-b2f0-4296-8708-7d0d425ad25b)

✅ We’ve successfully completed the lab!
